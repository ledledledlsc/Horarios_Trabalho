<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Hor√°rios de Trabalho</title>

<!-- PWA / APP -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">

<!-- iPhone / Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Hor√°rios">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #e9f0ff, #f7f9fc);
    text-align:center;
    padding: 18px;
    margin: 0;
  }

  h1{ color:#007bff; margin: 12px 0 10px; }
  #semanaTitulo{ font-size: 26px; color:#333; margin: 8px 0 12px; }

  .buttons{
    margin-bottom: 12px;
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
  }
  button{
    margin: 4px;
    padding: 10px 14px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover{ background:#0056b3; }

  #feriasBtn{ background:#8e44ad; }
  #feriasBtn:hover{ background:#6f2f8a; }

  #feriasBadge{
    display:none;
    margin-left:8px;
    background:#ffcc00;
    color:#2c3e50;
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: bold;
    font-size: 12px;
    vertical-align: middle;
  }

  /* cards acima */
  #feriasAviso, #proximasFerias{
    display:none;
    width: 100%;
    max-width: 900px;
    margin: 0 auto 12px;
    padding: 10px 12px;
    border-radius: 10px;
    font-weight: bold;
    opacity: 0;
    transform: translateY(-6px);
    transition: opacity .25s ease, transform .25s ease;
    text-align: center;   /* ‚úÖ garante centrado */
    box-sizing: border-box;
  }
  #feriasAviso{ background:#fff3cd; border:1px solid #ffeeba; color:#856404; }
  #proximasFerias{ background:#eef6ff; border:1px solid #cfe6ff; color:#1d4e89; }

  #feriasAviso.show, #proximasFerias.show{
    display:block; opacity:1; transform: translateY(0);
  }

  /* legenda */
  #legenda{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap: 12px;
    margin: 10px 0 14px;
    font-size: 14px;
  }
  .itemLegenda{ display:flex; align-items:center; gap:6px; }
  .colorBox{
    width: 16px; height: 16px;
    border-radius: 4px;
    display:inline-block;
  }

  /* tabela */
  .tableWrap{
    max-width: 980px;
    margin: 0 auto;
  }

  table{
    border-collapse: collapse;
    width: 100%;
    margin: 0 auto 18px;
    box-shadow: 0 0 16px rgba(0,0,0,0.10);
    background: white;
    border-radius: 14px;
    overflow: hidden;
  }
  th, td{
    border: 1px solid #ccc;
    padding: 12px;
    width: 14.28%;
    word-wrap: break-word;
    font-size: 16px;
    text-align:center;
  }
  th{ background:#e9ecef; font-weight: 800; }

  .green{ background:#27ae60; color:#fff; }
  .red{ background:#e74c3c; color:#fff; }
  .gray{ background:#bdc3c7; color:#000; }
  .darkgray{ background:#2c3e50; color:#fff; }
  .blue{ background:#3498db; color:#fff; }
  .blue-dark{ background:#1d4e89; color:#fff; font-weight: bold; }

  .today{
    border: 4px solid orange;
    font-weight: bold;
    text-decoration: underline;
    box-shadow: 0 0 10px rgba(255,165,0,0.7);
  }

  /* notas (4¬™ linha) */
  .notesRow td{
    font-size: 14px;
    background:#fff;
    color:#333;
    font-style: italic;
  }
  .noteCell{
    border-top: 2px dashed #bbb;
    background:#fafafa;
  }

  /* f√©rias por data */
  .vacCell{
    background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
    color:#2c3e50;
    font-weight: 800;
  }
  .weekVacTable{
    outline: 4px solid rgba(253,203,110,0.55);
    box-shadow: 0 0 18px rgba(253,203,110,0.35);
  }

  .colorBox.vac{ background: linear-gradient(135deg, #ffeaa7, #fdcb6e); border: 1px solid rgba(0,0,0,0.12); }

  /* modal f√©rias */
  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:9999;
  }
  .modal{
    width: min(520px, 100%);
    background: white;
    border-radius: 14px;
    padding: 16px;
    text-align:left;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    color:#000;
  }
  .modal h3{ margin:0 0 10px; font-size: 20px; color:#000; }
  .modal ul{ margin:0 0 12px; padding-left:18px; line-height:1.6; }
  .modal ul li{ color:#000; font-weight: 600; font-size: 15px; margin-bottom: 6px; }
  .modal .actions{ display:flex; justify-content:flex-end; gap:10px; }
  .btn-close{ background:#2c3e50; color:#fff; }
  .btn-close:hover{ background:#1d2a36; }

  /* logo */
  .footer-logo{
    margin-top: 18px;
    padding: 10px 0 18px;
    display:flex;
    justify-content:center;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity .25s ease, transform .25s ease;
  }
  .footer-logo.show{ opacity: 0.35; transform: translateY(0); }
  .footer-logo img{
    height: 40px;
    max-width: 180px;
    object-fit: contain;
  }

  /* dark */
  @media (prefers-color-scheme: dark){
    body{ background: radial-gradient(circle at top, #2b2b2b, #0f0f0f); color:#eee; }
    #semanaTitulo{ color:#eee; }
    table{ background:#1f1f1f; }
    th{ background:#2a2a2a; color:#fff; }
    th, td{ border-color:#444; }
    .notesRow td{ background:#1f1f1f; color:#eee; }
    .noteCell{ background:#222; border-top-color:#555; }
    #proximasFerias{ background:#13283b; border-color:#214563; color:#bfe1ff; }
    #feriasAviso{ background:#3a2f12; border-color:#6a5520; color:#ffe9b0; }
    .footer-logo.show{ opacity: 0.7; }
  }

  /* mobile layout: ocupa melhor o ecr√£ */
  @media (max-width: 700px){
    body{ padding: 12px; }
    h1{ font-size: 22px; }
    #semanaTitulo{ font-size: 20px; }
    button{ font-size: 14px; padding: 9px 12px; }
    th, td{ font-size: 14px; padding: 10px 6px; }
    #legenda{ gap: 10px; font-size: 13px; }
    table{ border-radius: 14px; }
  }
</style>
</head>
<body>

<h1>Hor√°rios de Trabalho</h1>

<div id="feriasAviso"></div>
<div id="proximasFerias"></div>

<div id="semanaTitulo"></div>
<div class="buttons">
  <button id="prevWeek">Semana anterior</button>
  <button id="nextWeek">Pr√≥xima semana</button>
  <button id="feriasBtn">üèñÔ∏è F√©rias <span id="feriasBadge">AGORA</span></button>
</div>

<div id="legenda">
  <div class="itemLegenda"><span class="colorBox blue"></span> dia</div>
  <div class="itemLegenda"><span class="colorBox blue-dark"></span> Chambre de commerce</div>
  <div class="itemLegenda"><span class="colorBox green"></span> manh√£</div>
  <div class="itemLegenda"><span class="colorBox red"></span> tarde</div>
  <div class="itemLegenda"><span class="colorBox gray"></span> Escola</div>
  <div class="itemLegenda"><span class="colorBox darkgray"></span> Livre</div>
  <div class="itemLegenda"><span class="colorBox vac"></span> F√©rias</div>
</div>

<div class="tableWrap">
  <table id="horarios"><tbody></tbody></table>
</div>

<!-- POPUP F√âRIAS -->
<div class="modal-overlay" id="feriasOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="feriasTitle">
    <h3 id="feriasTitle">üèñÔ∏è F√©rias</h3>
    <ul id="feriasList"></ul>
    <div class="actions">
      <button class="btn-close" id="feriasClose">Fechar</button>
    </div>
  </div>
</div>

<!-- LOGO -->
<div class="footer-logo" id="footerLogo">
  <a href="https://www.cactus.lu/fr" target="_blank" rel="noopener">
    <img
      src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Cactus_Logo.svg/960px-Cactus_Logo.svg.png"
      alt="Logo Cactus">
  </a>
</div>

<script>
/* ==========================
   LINKS
========================== */
const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Horarios_Trabalho.csv';
const FERIAS_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Ferias.csv';

/* ==========================
   CONFIG
========================== */
const diasSemana = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
const meses = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

let semanas = [];
let semanaAtual = 0;
let linhasCache = [];

let FERIAS_RANGES = [];
let ESTA_DE_FERIAS = false;

/* ==========================
   HELPERS
========================== */
function normalizeCell(x){
  return (x === null || x === undefined) ? '' : String(x).trim();
}

function toDateOnly(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

function inRange(today, start, end){
  const t = toDateOnly(today).getTime();
  const s = toDateOnly(start).getTime();
  const e = toDateOnly(end).getTime();
  return t >= s && t <= e;
}

function parseCSVLines(text){
  const lines = (text || '').trim().split(/\r?\n/).filter(Boolean);
  return lines.map(line => {
    const hasTab = line.includes('\t');
    const hasComma = line.includes(',');
    const hasSemi = line.includes(';');
    let sep = ',';
    if (hasTab) sep = '\t';
    else if (!hasComma && hasSemi) sep = ';';
    return line.split(sep).map(x => String(x).replace(/^"|"$/g,'').trim());
  });
}

function parseDateSafe(s){
  const t = normalizeCell(s);
  if(!t) return null;

  const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const y = parseInt(m[1],10);
    const mo = parseInt(m[2],10)-1;
    const d = parseInt(m[3],10);
    const dt = new Date(y, mo, d);
    dt.setHours(0,0,0,0);
    return dt;
  }

  const dt = new Date(t);
  if(isNaN(dt)) return null;
  dt.setHours(0,0,0,0);
  return dt;
}

function fmtDateShort(dt){
  const d = dt.getDate();
  const m = meses[dt.getMonth()];
  const y = dt.getFullYear();
  return `${String(d).padStart(2,'0')}/${m}/${y}`;
}

function daysBetween(a, b){
  const ms = 24*60*60*1000;
  return Math.round((toDateOnly(b).getTime() - toDateOnly(a).getTime()) / ms);
}

/* ==========================
   CDC (Chambre de commerce)
   - Aceita: CDC13/17, CDC 13/17, CDC13-17, cdc7/17, etc.
   - Mostra no site: 13-17H
========================== */
function parseCDC_(raw){
  const s = normalizeCell(raw);
  // permite espa√ßos e / ou -
  const m = s.match(/^CDC\s*(\d{1,2})\s*[\/\-]\s*(\d{1,2})$/i);
  if(!m) return null;
  const ini = parseInt(m[1],10);
  const fim = parseInt(m[2],10);
  if(Number.isNaN(ini) || Number.isNaN(fim)) return null;
  if(ini < 0 || ini > 24 || fim < 0 || fim > 24) return null;
  return { ini, fim };
}
function formatCDC_(cdc){
  return `${cdc.ini}-${cdc.fim}H`;
}

/* ==========================
   HOR√ÅRIO -> COR
========================== */
function classificarHorario(horario){
  const raw = normalizeCell(horario);

  // ‚úÖ CDC sempre azul escuro
  const cdc = parseCDC_(raw);
  if(cdc) return 'blue-dark';

  // normal (6-13H, 13-20H...)
  const clean = raw.replace(/\s/g,'').replace(/h/gi,'');
  const parts = clean.split('-');
  if(parts.length !== 2) return '';

  let inicio = parseFloat(parts[0].replace(':','.'));
  let fim    = parseFloat(parts[1].replace(':','.'));

  if(inicio === 7 && fim === 17) return 'blue-dark';
  if(inicio >= 12 && fim <= 21) return 'red';
  if(inicio >= 5 && fim <= 13) return 'green';
  if(inicio >= 10 && fim <= 17) return 'blue';

  return '';
}

/* ==========================
   F√âRIAS (Ferias.csv)
========================== */
function parseFeriasCSV(text){
  const lines = parseCSVLines(text);
  if(lines.length <= 1) return [];

  const headers = lines[0].map(h => h.toLowerCase());
  const idxStart = headers.indexOf('start');
  const idxEnd = headers.indexOf('end');
  const idxLabel = headers.indexOf('label');

  if(idxStart < 0 || idxEnd < 0) return [];

  return lines.slice(1).map(row => {
    const startStr = normalizeCell(row[idxStart]);
    const endStr   = normalizeCell(row[idxEnd]);
    const startDt  = parseDateSafe(startStr);
    const endDt    = parseDateSafe(endStr);
    return {
      startStr,
      endStr,
      startDt,
      endDt,
      label: idxLabel >= 0 ? normalizeCell(row[idxLabel]) : ''
    };
  }).filter(r => r.startDt && r.endDt);
}

function fmtFeriasRange(r){
  return `${fmtDateShort(r.startDt)} ‚Üí ${fmtDateShort(r.endDt)}${r.label ? ' ‚Äî ' + r.label : ''}`;
}

function getCurrentVacationRange(today){
  return FERIAS_RANGES.find(r => inRange(today, r.startDt, r.endDt)) || null;
}
function getVacationForDate(date){
  return FERIAS_RANGES.find(r => inRange(date, r.startDt, r.endDt)) || null;
}
function getNextVacation(today){
  const t = toDateOnly(today);
  const future = FERIAS_RANGES
    .filter(r => r.startDt && toDateOnly(r.startDt).getTime() > t.getTime())
    .sort((a,b) => a.startDt - b.startDt);
  return future[0] || null;
}

async function carregarFeriasCSV(){
  try{
    const res = await fetch(FERIAS_CSV_URL + '?cache=' + new Date().getTime());
    const text = await res.text();
    FERIAS_RANGES = parseFeriasCSV(text);
  }catch(e){
    console.log('Erro ao carregar f√©rias:', e);
    FERIAS_RANGES = [];
  }
}

function updateTopCards(){
  const hoje = new Date(); hoje.setHours(0,0,0,0);

  const badge = document.getElementById('feriasBadge');
  const aviso = document.getElementById('feriasAviso');
  const prox  = document.getElementById('proximasFerias');
  const footerLogo = document.getElementById('footerLogo');

  // lista no modal
  const ul = document.getElementById('feriasList');
  ul.innerHTML = '';
  if(!FERIAS_RANGES.length){
    const li = document.createElement('li');
    li.textContent = 'Sem f√©rias encontradas.';
    ul.appendChild(li);
  }else{
    FERIAS_RANGES.forEach(r=>{
      const li = document.createElement('li');
      li.textContent = fmtFeriasRange(r);
      ul.appendChild(li);
    });
  }

  const current = getCurrentVacationRange(hoje);
  ESTA_DE_FERIAS = !!current;

  if(ESTA_DE_FERIAS){
    badge.style.display = 'inline-block';
    aviso.textContent = `üèñÔ∏è Est√°s de f√©rias agora: ${fmtFeriasRange(current)}`;
    aviso.classList.add('show');

    prox.classList.remove('show');
    prox.style.display = 'none';
  }else{
    badge.style.display = 'none';
    aviso.classList.remove('show');

    const next = getNextVacation(hoje);
    if(next){
      const dias = daysBetween(hoje, next.startDt);
      prox.textContent = `üîî Pr√≥ximas f√©rias em ${dias} dia${dias===1?'':'s'}: ${fmtFeriasRange(next)}`;
      prox.classList.add('show');
    }else{
      prox.classList.remove('show');
      prox.style.display = 'none';
    }
  }

  // logo com anima√ß√£o
  if(footerLogo){
    if(ESTA_DE_FERIAS){
      footerLogo.classList.remove('show');
      setTimeout(() => { footerLogo.style.display = 'none'; }, 260);
    }else{
      footerLogo.style.display = 'flex';
      setTimeout(() => footerLogo.classList.add('show'), 20);
    }
  }
}

/* ==========================
   HOR√ÅRIOS (Horarios_Trabalho.csv)
========================== */
async function carregarCSV(){
  const res = await fetch(GITHUB_CSV_URL + '?cache=' + new Date().getTime());
  const text = await res.text();
  linhasCache = text.split('\n').map(l => l.split(','));

  // detectar blocos "SEMANA"
  semanas = [];
  let i = 0;
  while(i < linhasCache.length){
    if(linhasCache[i][0] && String(linhasCache[i][0]).toUpperCase().includes('SEMANA')){
      let start = i;
      let end = start + 2;
      while(end + 1 < linhasCache.length &&
            linhasCache[end + 1][0] &&
            !String(linhasCache[end + 1][0]).toUpperCase().includes('SEMANA')){
        end++;
      }
      semanas.push({start, end});
      i = end + 1;
    }else i++;
  }

  // escolher semana atual
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  for(let s=0;s<semanas.length;s++){
    const semana = semanas[s];
    const linhaDatas = linhasCache[semana.start+1] || [];
    if(linhaDatas.some(c=>{
      const d = new Date(c);
      if(isNaN(d)) return false;
      d.setHours(0,0,0,0);
      return d.getTime() === hoje.getTime();
    })){
      semanaAtual = s;
      break;
    }
  }

  mostrarSemana(semanaAtual);
}

function mostrarSemana(index){
  const tbody = document.querySelector('#horarios tbody');
  tbody.innerHTML = '';

  const semana = semanas[index];
  if(!semana) return;

  const table = document.getElementById('horarios');
  table.classList.remove('weekVacTable');

  document.getElementById('semanaTitulo').textContent = normalizeCell(linhasCache[semana.start][0]);

  const linhaDatas    = (linhasCache[semana.start+1] || []).map(normalizeCell);
  const linhaHorarios = (linhasCache[semana.start+2] || []).map(normalizeCell);

  const linhaNotasRaw = linhasCache[semana.start+3];
  const linhaNotas = linhaNotasRaw ? linhaNotasRaw.map(normalizeCell) : null;
  const temNotas = linhaNotas && linhaNotas.some(c => c && c.length > 0);

  // header
  const trHead = document.createElement('tr');
  linhaDatas.forEach(c=>{
    const th = document.createElement('th');
    const d = new Date(c);
    if(!isNaN(d)){
      const ds = diasSemana[d.getDay()];
      th.textContent = `${ds} ${d.getDate()}/${meses[d.getMonth()]}`;
    }else{
      th.textContent = c;
    }
    trHead.appendChild(th);
  });
  tbody.appendChild(trHead);

  // linha hor√°rios
  const trHorario = document.createElement('tr');
  const hoje = new Date(); hoje.setHours(0,0,0,0);

  let totalDiasValidos = 0;
  let diasFerias = 0;

  linhaHorarios.forEach((celula, j)=>{
    const td = document.createElement('td');

    const dataCelula = new Date(linhaDatas[j]);
    const dataOk = !isNaN(dataCelula);

    if(dataOk){
      dataCelula.setHours(0,0,0,0);
      totalDiasValidos++;

      // f√©rias por data
      const vac = getVacationForDate(dataCelula);
      if(vac){
        diasFerias++;
        td.textContent = 'F√âRIAS';
        td.classList.add('vacCell');
        td.title = vac.label ? `F√©rias: ${vac.label}` : 'F√©rias';
      }else{
        // CDC?
        const cdc = parseCDC_(celula);
        if(cdc){
          td.textContent = formatCDC_(cdc);  // ‚úÖ mostra 13-17H no site
          td.classList.add('blue-dark');
        }else{
          td.textContent = celula;

          const valor = celula.toLowerCase();
          const cor = classificarHorario(celula);

          if(cor) td.classList.add(cor);
          else if(valor.includes('escola')) td.classList.add('gray');
          else if(valor.includes('feriado')) td.classList.add('red');
          else if(valor.includes('libre') || valor.includes('livre')) td.classList.add('darkgray');
        }
      }

      if(dataCelula.getTime() === hoje.getTime()){
        td.classList.add('today');
      }
    }else{
      td.textContent = celula;
    }

    trHorario.appendChild(td);
  });

  tbody.appendChild(trHorario);

  // semana inteira f√©rias
  if(totalDiasValidos > 0 && diasFerias === totalDiasValidos){
    table.classList.add('weekVacTable');
    const aviso = document.getElementById('feriasAviso');
    if(!ESTA_DE_FERIAS){
      aviso.textContent = 'üèñÔ∏è Esta semana √© 100% F√âRIAS.';
      aviso.classList.add('show');
    }
  }

  // notas
  if(temNotas){
    const trNotas = document.createElement('tr');
    trNotas.classList.add('notesRow');
    linhaNotas.forEach(n=>{
      const td = document.createElement('td');
      td.classList.add('noteCell');
      td.textContent = n || '';
      trNotas.appendChild(td);
    });
    tbody.appendChild(trNotas);
  }
}

/* ==========================
   BOT√ïES
========================== */
document.getElementById('prevWeek').addEventListener('click', ()=>{
  if(semanaAtual > 0) semanaAtual--;
  mostrarSemana(semanaAtual);
});
document.getElementById('nextWeek').addEventListener('click', ()=>{
  if(semanaAtual < semanas.length - 1) semanaAtual++;
  mostrarSemana(semanaAtual);
});

/* ==========================
   MODAL F√âRIAS
========================== */
const overlay = document.getElementById('feriasOverlay');
document.getElementById('feriasBtn').addEventListener('click', ()=>{
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
});
document.getElementById('feriasClose').addEventListener('click', ()=>{
  overlay.style.display = 'none';
  overlay.setAttribute('aria-hidden','true');
});
overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
  }
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && overlay.style.display === 'flex'){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
  }
});

/* ==========================
   ARRANQUE
========================== */
(async ()=>{
  await carregarFeriasCSV();
  updateTopCards();
  await carregarCSV();
})();
</script>

</body>
</html>
