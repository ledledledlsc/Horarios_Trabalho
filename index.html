<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Hor√°rios de Trabalho</title>

  <!-- PWA / APP -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hor√°rios">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e9f0ff, #f7f9fc);
      text-align: center;
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #007bff;
      margin: 15px 0 5px;
      font-size: 2.2rem;
    }

    #semanaTitulo {
      font-size: 1.6rem;
      color: #333;
      margin: 10px 0 20px;
      font-weight: bold;
    }

    .buttons {
      margin: 15px 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
      max-width: 900px;
    }

    button {
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      transition: all 0.25s;
      flex: 1 1 130px;
      max-width: 170px;
    }

    button:hover {
      background: #0056b3;
      transform: scale(1.05);
    }

    #feriasBtn {
      background: #8e44ad;
    }

    #feriasBtn:hover {
      background: #6f2f8a;
    }

    #feriasBadge {
      display: none;
      margin-left: 8px;
      background: #ffcc00;
      color: #2c3e50;
      padding: 3px 9px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      animation: pulseBadge 2s infinite;
    }

    @keyframes pulseBadge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    #feriasAviso, #proximasFerias {
      display: none;
      width: 90%;
      max-width: 900px;
      margin: 10px auto;
      padding: 14px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #feriasAviso.show, #proximasFerias.show {
      display: block;
    }

    #feriasAviso {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }

    #proximasFerias {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
    }

    table.horizontal-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin: 0 auto 30px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px 10px;
      font-size: 1rem;
    }

    th {
      background: #1d4e89;
      color: white;
      font-weight: bold;
    }

    .green { background: #27ae60; color: white; font-weight: bold; }
    .red { background: #e74c3c; color: white; font-weight: bold; }
    .blue { background: #3498db; color: white; font-weight: bold; }
    .blue-dark { background: #1d4e89; color: white; font-weight: bold; }
    .darkgray { background: #455a64; color: white; font-weight: bold; }
    .gray { background: #cfd8dc; color: #333; font-weight: bold; }
    .feriado { background: #c62828; color: white; font-weight: bold; }

    .vacCell {
      background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
      background-size: 400%;
      animation: gradPulse 6s infinite;
      color: #333;
      font-weight: bold;
    }

    @keyframes gradPulse {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .today {
      border: 4px solid orange !important;
      box-shadow: 0 0 12px rgba(255,165,0,0.5);
    }

    td:hover {
      transform: scale(1.04);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.25s;
    }

    #legenda {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin: 20px auto;
      max-width: 900px;
      padding: 0 10px;
    }

    .itemLegenda {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .colorBox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      width: min(520px, 90%);
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }

    .footer-logo {
      margin-top: auto;
      padding: 20px 0;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s;
    }

    .footer-logo.show { opacity: 0.5; transform: translateY(0); }

    .footer-logo img {
      height: 48px;
      transition: transform 0.3s;
    }

    .footer-logo img:hover { transform: scale(1.08); }

    .error {
      color: red;
      font-weight: bold;
      margin: 20px;
      font-size: 1.2rem;
    }

    /* Dark mode autom√°tico */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #121212, #1e1e1e);
        color: #e0e0e0;
      }
      table { background: #1e1e1e; }
      th { background: #0d47a1; color: white; }
      th, td { border-color: #444; }
      #feriasAviso { background: #3a2f12; color: #ffe9b0; border-color: #6a5520; }
      #proximasFerias { background: #13283b; color: #bfe1ff; border-color: #214563; }
      .feriado { background: #b71c1c; color: white; }
      .footer-logo.show { opacity: 0.7; }
      .footer-logo img { filter: brightness(1.35) contrast(1.1); }
    }

    /* Mobile - tabela vertical (ativa abaixo de 600px) */
    @media (max-width: 600px) {
      body { padding: 5px; }
      h1 { font-size: 1.8rem; margin: 10px 0; }
      #semanaTitulo { font-size: 1.3rem; margin: 5px 0 10px; }
      .buttons { padding: 0 5px; gap: 6px; }
      button { padding: 10px; font-size: 0.9rem; }

      /* Esconde tabela horizontal no mobile */
      table.horizontal-table {
        display: none !important;
      }

      /* Mostra vertical */
      .vertical-schedule {
        display: block !important;
        width: 100%;
        margin: 0 auto 30px;
      }

      .day-block {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 12px 0;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      }

      .day-header {
        font-weight: bold;
        color: #1d4e89;
        margin-bottom: 10px;
        font-size: 1.2rem;
        text-align: center;
      }

      .day-content {
        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        border-radius: 6px;
      }

      .day-content.vacCell {
        background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
        animation: gradPulse 6s infinite;
      }

      .day-content.today {
        border: 3px solid orange;
        box-shadow: 0 0 10px rgba(255,165,0,0.5);
      }

      .day-content.feriado {
        background: #c62828;
        color: white;
      }

      #legenda {
        gap: 8px;
        padding: 0 5px;
        font-size: 0.8rem;
        justify-content: space-evenly;
      }

      .modal {
        width: 100%;
        padding: 16px;
        border-radius: 0;
        height: 100vh;
        max-height: none;
      }

      .modal-overlay {
        padding: 0;
      }
    }
  </style>
</head>
<body>

  <h1>Hor√°rios de Trabalho</h1>

  <div id="feriasAviso"></div>
  <div id="proximasFerias"></div>

  <div id="semanaTitulo">Carregando...</div>

  <div class="buttons">
    <button id="prevWeek">Semana anterior</button>
    <button id="nextWeek">Pr√≥xima semana</button>
    <button id="feriasBtn">üèñÔ∏è F√©rias <span id="feriasBadge">AGORA</span></button>
  </div>

  <div id="legenda">
    <div class="itemLegenda"><span class="colorBox blue"></span> dia</div>
    <div class="itemLegenda"><span class="colorBox blue-dark"></span> Chambre de commerce</div>
    <div class="itemLegenda"><span class="colorBox green"></span> manh√£</div>
    <div class="itemLegenda"><span class="colorBox red"></span> tarde</div>
    <div class="itemLegenda"><span class="colorBox gray"></span> Escola</div>
    <div class="itemLegenda"><span class="colorBox darkgray"></span> Livre</div>
    <div class="itemLegenda"><span class="colorBox feriado" style="background:#c62828"></span> Feriado</div>
  </div>

  <div id="errorMsg" class="error"></div>

  <!-- Tabela horizontal (PC) -->
  <table id="horarios" class="horizontal-table">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Tabela vertical (Mobile) -->
  <div id="verticalSchedule" class="vertical-schedule" style="display:none;"></div>

  <div class="modal-overlay" id="feriasOverlay">
    <div class="modal">
      <h3>üèñÔ∏è F√©rias</h3>
      <ul id="feriasList"></ul>
      <div class="actions">
        <button id="feriasClose">Fechar</button>
      </div>
    </div>
  </div>

  <div class="footer-logo" id="footerLogo">
    <a href="https://www.cactus.lu/fr" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Cactus_Logo.svg/960px-Cactus_Logo.svg.png" alt="Logo Cactus">
    </a>
  </div>

  <script>
    // CONFIGURA√á√ïES
    const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Horarios_Trabalho.csv';
    const FERIAS_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Ferias.csv';
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];

    let semanas = [];
    let semanaAtual = 0;
    let linhasCache = [];

    // FUN√á√ïES AUXILIARES
    function normalizeCell(x) { return (x === null || x === undefined) ? '' : String(x).trim(); }
    function toDateOnly(d) { const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function inRange(today, start, end) { const t = toDateOnly(today).getTime(); const s = toDateOnly(start).getTime(); const e = toDateOnly(end).getTime(); return t >= s && t <= e; }
    function parseCSVLines(text) {
      const lines = (text || '').trim().split(/\r?\n/).filter(l => l.trim());
      return lines.map(line => line.split(/,|;|\t/).map(x => normalizeCell(x)));
    }
    function parseDateSafe(s) {
      const t = normalizeCell(s);
      if (!t) return null;
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const dt = new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
        if (!isNaN(dt.getTime())) return toDateOnly(dt);
      }
      const dt = new Date(t);
      if (!isNaN(dt.getTime())) return toDateOnly(dt);
      return null;
    }
    function fmtDateShort(dt) {
      const d = dt.getDate();
      const m = meses[dt.getMonth()];
      const y = dt.getFullYear();
      return `${String(d).padStart(2,'0')}/${m}/${y}`;
    }
    function daysBetween(a, b) {
      const ms = 86400000;
      return Math.round((toDateOnly(b).getTime() - toDateOnly(a).getTime()) / ms);
    }

    // F√âRIAS
    let FERIAS_RANGES = [];
    let ESTA_DE_FERIAS = false;

    function parseFeriasCSV(text) {
      const lines = parseCSVLines(text);
      if (lines.length <= 1) return [];
      const headers = lines[0].map(h => h.toLowerCase());
      const si = headers.indexOf('start');
      const ei = headers.indexOf('end');
      const li = headers.indexOf('label');
      if (si < 0 || ei < 0) return [];
      return lines.slice(1).map(row => {
        const startDt = parseDateSafe(row[si]);
        const endDt = parseDateSafe(row[ei]);
        if (!startDt || !endDt) return null;
        return { startDt, endDt, label: li >= 0 ? normalizeCell(row[li]) : '' };
      }).filter(Boolean);
    }

    async function carregarFeriasCSV() {
      try {
        const res = await fetch(FERIAS_CSV_URL + '?cache=' + Date.now());
        const text = await res.text();
        FERIAS_RANGES = parseFeriasCSV(text);
      } catch (e) {
        console.error('Erro ao carregar f√©rias:', e);
        FERIAS_RANGES = [];
      }
    }

    function getCurrentVacationRange(today) {
      return FERIAS_RANGES.find(r => inRange(today, r.startDt, r.endDt)) || null;
    }

    function getVacationForDate(date) {
      return FERIAS_RANGES.find(r => inRange(date, r.startDt, r.endDt)) || null;
    }

    function getNextVacation(today) {
      const t = toDateOnly(today);
      return FERIAS_RANGES.filter(r => toDateOnly(r.startDt).getTime() > t.getTime()).sort((a,b) => a.startDt - b.startDt)[0] || null;
    }

    function updateTopCards() {
      const hoje = new Date(); hoje.setHours(0,0,0,0);
      const badge = document.getElementById('feriasBadge');
      const aviso = document.getElementById('feriasAviso');
      const prox = document.getElementById('proximasFerias');
      const footer = document.getElementById('footerLogo');
      const ul = document.getElementById('feriasList'); ul.innerHTML = '';

      if (!FERIAS_RANGES.length) {
        ul.innerHTML = '<li>Sem f√©rias no CSV.</li>';
      } else {
        FERIAS_RANGES.forEach(r => {
          const li = document.createElement('li');
          li.textContent = `${fmtDateShort(r.startDt)} ‚Üí ${fmtDateShort(r.endDt)}${r.label ? ' ‚Äî ' + r.label : ''}`;
          ul.appendChild(li);
        });
      }

      const current = getCurrentVacationRange(hoje);
      ESTA_DE_FERIAS = !!current;

      if (ESTA_DE_FERIAS) {
        badge.style.display = 'inline-block';
        aviso.textContent = `üèñÔ∏è F√©rias agora: ${fmtDateShort(current.startDt)} ‚Üí ${fmtDateShort(current.endDt)}`;
        aviso.classList.add('show');
        prox.classList.remove('show');
        footer.style.display = 'none';
      } else {
        badge.style.display = 'none';
        aviso.classList.remove('show');
        const next = getNextVacation(hoje);
        if (next) {
          const dias = daysBetween(hoje, next.startDt);
          prox.textContent = `üîî Pr√≥ximas f√©rias em ${dias} dia${dias===1?'':'s'}: ${fmtDateShort(next.startDt)} ‚Üí ${fmtDateShort(next.endDt)}`;
          prox.classList.add('show');
        } else {
          prox.classList.remove('show');
          footer.style.display = 'flex';
          setTimeout(() => footer.classList.add('show'), 300);
        }
      }
    }

    // HOR√ÅRIOS
    function classificarHorario(horario) {
      const raw = normalizeCell(horario).toUpperCase().trim();
      let texto = raw;
      let classe = '';
      let tooltip = '';
      let innerHTML = null;

      // TFeriado / Feriado
      if (raw.includes('TFERIADO') || raw.includes('FERIADO')) {
        classe = 'feriado';
        texto = 'Feriado';
        tooltip = 'Dia feriado';
        return { classe, texto, tooltip };
      }

      // CDC
      const cdcMatch = raw.match(/^CDC\s*(\d{1,2})\s*[\/\-]?\s*(\d{1,2})?$/i);
      if (cdcMatch || raw.startsWith('CDC')) {
        classe = 'blue-dark';
        tooltip = 'Chambre de Commerce';
        let intervalo = 'CDC';
        if (cdcMatch) {
          const a = String(cdcMatch[1]).padStart(2, '0');
          const b = cdcMatch[2] ? String(cdcMatch[2]).padStart(2, '0') : '';
          intervalo = b ? `${a}-${b}H` : a;
        }
        innerHTML = `<span class="cdc-icon">üè´</span><span>${intervalo}</span>`;
        return { classe, texto: intervalo, tooltip, innerHTML };
      }

      if (raw.startsWith('M')) { classe = 'green'; texto = raw.slice(1).trim(); tooltip = 'Manh√£'; }
      else if (raw.startsWith('T')) { classe = 'red'; texto = raw.slice(1).trim(); tooltip = 'Tarde'; }
      else if (raw.startsWith('D')) { classe = 'blue'; texto = raw.slice(1).trim(); tooltip = 'Dia inteiro'; }
      else if (raw.startsWith('N') || raw.includes('LIVRE') || raw.includes('LIBRE')) { classe = 'darkgray'; texto = 'Livre'; tooltip = 'Livre'; }
      else if (raw.includes('ESCOLA')) { classe = 'gray'; texto = 'Escola'; tooltip = 'Escola'; }
      else if (raw === 'F' || raw.includes('F√âRIAS') || raw.includes('FERIAS')) { classe = 'vacCell'; texto = 'F√©rias'; tooltip = 'F√©rias'; }

      return { classe, texto, tooltip, innerHTML };
    }

    async function carregarCSV() {
      try {
        const res = await fetch(GITHUB_CSV_URL + '?cache=' + Date.now());
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const text = await res.text();
        if (!text.trim()) throw new Error('CSV vazio');
        linhasCache = parseCSVLines(text);
        if (linhasCache.length === 0) throw new Error('Nenhuma linha no CSV');

        semanas = [];
        let i = 0;
        while (i < linhasCache.length) {
          const line = linhasCache[i];
          if (line[0] && line[0].toUpperCase().includes('SEMANA')) {
            let start = i;
            let end = i + 1;
            while (end < linhasCache.length && !linhasCache[end][0]?.toUpperCase().includes('SEMANA')) end++;
            semanas.push(linhasCache.slice(start, end));
            i = end;
          } else i++;
        }

        if (semanas.length === 0) {
          throw new Error('Sem blocos de "SEMANA" encontrados no CSV');
        }

        semanaAtual = 0;
        const hoje = toDateOnly(new Date());
        for (let s = 0; s < semanas.length; s++) {
          const datas = semanas[s][1] || [];
          if (datas.some(d => {
            const dt = parseDateSafe(d);
            return dt && dt.getTime() === hoje.getTime();
          })) {
            semanaAtual = s;
            break;
          }
        }

        mostrarSemana(semanaAtual);
      } catch (e) {
        console.error('Erro CSV:', e);
        document.getElementById('semanaTitulo').textContent = 'Erro ao carregar hor√°rios';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = e.message + ' ‚Äî Verifica Horarios_Trabalho.csv no GitHub';
        document.body.appendChild(errorDiv);
      }
    }

    function mostrarSemana(idx) {
      const tbody = document.querySelector('#horarios tbody');
      tbody.innerHTML = '';
      const verticalDiv = document.getElementById('verticalSchedule');
      verticalDiv.innerHTML = '';

      const semana = semanas[idx];
      if (!semana) return;

      const tituloRaw = semana[0][0] || '';
      let titulo = tituloRaw.replace(/:.*/, '').trim().toUpperCase();
      document.getElementById('semanaTitulo').textContent = titulo || 'Semana ' + (idx + 1);

      const datas = semana[1] || [];
      const horarios = semana[2] || [];
      const hoje = toDateOnly(new Date());

      // Horizontal (PC)
      const trHead = document.createElement('tr');
      datas.forEach(d => {
        const th = document.createElement('th');
        const dt = parseDateSafe(d);
        if (dt) {
          const diaSem = diasSemana[dt.getDay()];
          th.textContent = `${diaSem} ${dt.getDate()}/${meses[dt.getMonth()]}`;
        } else th.textContent = d;
        trHead.appendChild(th);
      });
      tbody.appendChild(trHead);

      const trHorario = document.createElement('tr');
      horarios.forEach((c, j) => {
        const info = classificarHorario(c);
        const td = document.createElement('td');
        td.style.fontWeight = 'bold';

        if (info.innerHTML) {
          td.innerHTML = info.innerHTML;
        } else {
          td.textContent = info.texto;
        }

        if (info.classe) td.classList.add(info.classe);
        if (info.tooltip) td.title = info.tooltip;

        const dt = parseDateSafe(datas[j]);
        if (dt && dt.getTime() === hoje.getTime()) td.classList.add('today');

        const vac = getVacationForDate(dt);
        if (vac) {
          td.classList.add('vacCell');
          td.textContent = 'F√©rias';
          td.title = vac.label || 'F√©rias';
        }

        trHorario.appendChild(td);
      });
      tbody.appendChild(trHorario);

      // Vertical (Mobile) - cria blocos para cada dia
      datas.forEach((d, j) => {
        const dt = parseDateSafe(d);
        if (!dt) return;

        const diaSem = diasSemana[dt.getDay()];
        const dataText = `${diaSem} ${dt.getDate()}/${meses[dt.getMonth()]}`;

        const block = document.createElement('div');
        block.className = 'day-block';

        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = dataText;
        block.appendChild(header);

        const content = document.createElement('div');
        content.className = 'day-content';

        const c = horarios[j] || '';
        const info = classificarHorario(c);
        if (info.innerHTML) {
          content.innerHTML = info.innerHTML;
        } else {
          content.textContent = info.texto;
        }

        if (info.classe) content.classList.add(info.classe);
        if (info.tooltip) content.title = info.tooltip;

        if (dt.getTime() === hoje.getTime()) content.classList.add('today');
        const vac = getVacationForDate(dt);
        if (vac) {
          content.classList.add('vacCell');
          content.textContent = 'F√©rias';
          content.title = vac.label || 'F√©rias';
        }

        block.appendChild(content);
        verticalDiv.appendChild(block);
      });

      // Anima√ß√£o staggered
      const cells = [...tbody.querySelectorAll('td'), ...verticalDiv.querySelectorAll('.day-content')];
      cells.forEach((c, i) => {
        c.style.opacity = 0;
        c.style.transform = 'scale(0.92) translateY(8px)';
        setTimeout(() => {
          c.style.transition = 'opacity 0.5s ease, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
          c.style.opacity = 1;
          c.style.transform = 'scale(1) translateY(0)';
        }, i * 50);
      });
    }

    document.getElementById('prevWeek').addEventListener('click', () => { if (semanaAtual > 0) mostrarSemana(--semanaAtual); });
    document.getElementById('nextWeek').addEventListener('click', () => { if (semanaAtual < semanas.length - 1) mostrarSemana(++semanaAtual); });
    document.getElementById('feriasBtn').addEventListener('click', () => document.getElementById('feriasOverlay').classList.add('show'));
    document.getElementById('feriasClose').addEventListener('click', () => document.getElementById('feriasOverlay').classList.remove('show'));

    (async () => {
      await carregarFeriasCSV();
      updateTopCards();
      await carregarCSV();
      document.getElementById('footerLogo').classList.add('show');
    })();
  </script>
</body>
</html>
