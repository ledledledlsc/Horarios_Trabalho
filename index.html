<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Hor√°rios de Trabalho</title>

<!-- PWA / APP -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Hor√°rios">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #e9f0ff, #f7f9fc);
  text-align: center;
  margin: 0;
  padding: 10px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 { color: #007bff; margin: 10px 0 5px; font-size: 2rem; }

#semanaTitulo { font-size: 1.6rem; color: #333; margin: 10px 0 15px; font-weight: bold; }

.buttons { margin: 10px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; width: 100%; max-width: 900px; }
button { padding: 10px 16px; font-size: 1rem; border-radius: 8px; border: none; background: #007bff; color: white; cursor: pointer; transition: 0.2s; flex: 1 1 120px; max-width: 160px; }
button:hover { background: #0056b3; }
#feriasBtn { background: #8e44ad; }
#feriasBtn:hover { background: #6f2f8a; }

#feriasBadge {
  display: none;
  margin-left: 8px;
  background: #ffcc00;
  color: #2c3e50;
  padding: 2px 8px;
  border-radius: 999px;
  font-weight: bold;
  font-size: 12px;
}

#feriasAviso, #proximasFerias {
  display: none;
  width: 90%;
  max-width: 900px;
  margin: 10px auto;
  padding: 12px;
  border-radius: 10px;
  font-weight: bold;
}
#feriasAviso.show, #proximasFerias.show { display: block; }
#feriasAviso { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
#proximasFerias { background: #eef6ff; border: 1px solid #cfe6ff; color: #1d4e89; }

table { border-collapse: collapse; width: 90%; max-width: 900px; margin: 0 auto 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
th, td { border: 1px solid #ccc; padding: 10px; font-size: 1rem; }
th { background: #e9ecef; }

.green { background: #27ae60; color: white; }
.red { background: #e74c3c; color: white; }
.blue { background: #3498db; color: white; }
.blue-dark { background: #1d4e89; color: white; font-weight: bold; }
.gray { background: #bdc3c7; color: black; }
.darkgray { background: #2c3e50; color: white; }
.vacCell { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); color: #2c3e50; font-weight: bold; }

.today { border: 4px solid orange; font-weight: bold; box-shadow: 0 0 10px rgba(255,165,0,0.7); }

#legenda { display: flex; justify-content: center; flex-wrap: wrap; margin: 15px 0; gap: 12px; max-width: 900px; }
.itemLegenda { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
.modal-overlay.show { display: flex; }
.modal { width: min(520px, 90%); background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }

.footer-logo { margin-top: auto; padding: 20px 0; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
.footer-logo.show { opacity: 0.4; transform: translateY(0); }
.footer-logo img { height: 45px; }

@media (prefers-color-scheme: dark) {
  body { background: linear-gradient(135deg, #121212, #1e1e1e); color: #eaeaea; }
  table { background: #1f1f1f; }
  th { background: #2a2a2a; }
  th, td { border-color: #444; }
}

@media (max-width: 600px) {
  body { padding: 8px; }
  h1 { font-size: 1.8rem; margin: 8px 0; }
  #semanaTitulo { font-size: 1.3rem; margin: 8px 0; }
  .buttons { gap: 8px; padding: 0 8px; }
  button { padding: 10px 12px; font-size: 0.9rem; }
  table { width: 100%; margin: 0; border-radius: 0; }
  th, td { padding: 8px 6px; font-size: 0.85rem; }
  #legenda { gap: 8px; font-size: 0.85rem; }
  .modal { width: 95%; padding: 16px; border-radius: 0; height: 100vh; max-height: none; }
  .modal-overlay { padding: 0; }
}
</style>
</head>
<body>

<h1>Hor√°rios de Trabalho</h1>

<div id="feriasAviso"></div>
<div id="proximasFerias"></div>

<div id="semanaTitulo"></div>

<div class="buttons">
  <button id="prevWeek">Semana anterior</button>
  <button id="nextWeek">Pr√≥xima semana</button>
  <button id="feriasBtn">üèñÔ∏è F√©rias <span id="feriasBadge">AGORA</span></button>
</div>

<div id="legenda">
  <div class="itemLegenda"><span class="colorBox blue"></span> dia</div>
  <div class="itemLegenda"><span class="colorBox blue-dark"></span> Chambre de commerce</div>
  <div class="itemLegenda"><span class="colorBox green"></span> manh√£</div>
  <div class="itemLegenda"><span class="colorBox red"></span> tarde</div>
  <div class="itemLegenda"><span class="colorBox gray"></span> Escola</div>
  <div class="itemLegenda"><span class="colorBox darkgray"></span> Livre</div>
  <div class="itemLegenda"><span class="colorBox vac"></span> F√©rias</div>
</div>

<table id="horarios"><thead><tr></tr></thead><tbody></tbody></table>

<div class="modal-overlay" id="feriasOverlay">
  <div class="modal">
    <h3>üèñÔ∏è F√©rias</h3>
    <ul id="feriasList"></ul>
    <div class="actions">
      <button id="feriasClose">Fechar</button>
    </div>
  </div>
</div>

<div class="footer-logo" id="footerLogo">
  <a href="https://www.cactus.lu/fr" target="_blank">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Cactus_Logo.svg/960px-Cactus_Logo.svg.png" alt="Logo Cactus">
  </a>
</div>

<script>
// (Mant√©m todas as fun√ß√µes do teu c√≥digo antigo: normalizeCell, toDateOnly, inRange, parseDateSafe, fmtDateShort, daysBetween, parseFeriasCSV, getCurrentVacationRange, getNextVacation, carregarFeriasCSV, updateTopCards)

// CLASSIFICAR HOR√ÅRIO (vers√£o limpa do teu c√≥digo antigo + remo√ß√£o de letra inicial)
function classificarHorario(horario) {
  const raw = normalizeCell(horario).toUpperCase();
  let classe = '';
  let texto = raw;

  if (raw.startsWith('M')) { classe = 'green'; texto = raw.slice(1).trim() || 'Manh√£'; }
  else if (raw.startsWith('T')) { classe = 'red'; texto = raw.slice(1).trim() || 'Tarde'; }
  else if (raw.startsWith('D')) { classe = 'blue'; texto = raw.slice(1).trim() || 'Dia'; }
  else if (raw.startsWith('N') || raw.includes('LIVRE') || raw.includes('LIBRE')) { classe = 'darkgray'; texto = 'Livre'; }
  else if (raw.includes('ESCOLA')) { classe = 'gray'; texto = 'Escola'; }
  else if (raw.startsWith('CDC')) { classe = 'blue-dark'; texto = 'CDC'; }
  else if (raw === 'F' || raw.includes('FERIAS') || raw.includes('F√âRIAS')) { classe = 'vacCell'; texto = 'F√©rias'; }

  return { classe, texto };
}

// CARREGAR CSV + AUTO-SELECIONAR SEMANA ATUAL (corrigido)
async function carregarCSV() {
  const res = await fetch(GITHUB_CSV_URL + '?cache=' + new Date().getTime());
  const text = await res.text();
  linhasCache = parseCSVLines(text);  // usa a fun√ß√£o do teu c√≥digo antigo

  semanas = [];
  let currentWeek = [];
  for (let line of linhasCache) {
    if (line[0] && line[0].toUpperCase().includes('SEMANA')) {
      if (currentWeek.length) semanas.push(currentWeek);
      currentWeek = [line];
    } else if (line.length > 1) currentWeek.push(line);
  }
  if (currentWeek.length) semanas.push(currentWeek);

  // Encontrar semana com o dia atual
  semanaAtual = 0;
  const hoje = toDateOnly(new Date());
  for (let i = 0; i < semanas.length; i++) {
    const week = semanas[i];
    const datas = week[1] || []; // linha de datas
    for (let d of datas) {
      const dt = parseDateSafe(d);
      if (dt && dt.getTime() === hoje.getTime()) {
        semanaAtual = i;
        break;
      }
    }
  }

  mostrarSemana(semanaAtual);
}

// MOSTRAR SEMANA (t√≠tulo corrigido, cabe√ßalho curto)
function mostrarSemana(idx) {
  const tbody = document.querySelector('#horarios tbody');
  tbody.innerHTML = '';
  const semana = semanas[idx];
  if (!semana) return;

  // T√≠tulo simples
  const tituloRaw = semana[0][0] || '';
  document.getElementById('semanaTitulo').textContent = tituloRaw.replace(/:.*/, '').trim().toUpperCase() || 'Semana ' + (idx + 1);

  // Cabe√ßalho com dias curtos
  const headerRow = document.querySelector('#horarios thead tr');
  headerRow.innerHTML = '';
  const datas = semana[1] || [];
  datas.forEach(d => {
    const th = document.createElement('th');
    const dt = parseDateSafe(d);
    if (dt) {
      const diaSem = diasSemana[dt.getDay()];
      th.textContent = `${diaSem} ${dt.getDate()}`;
    } else th.textContent = d;
    headerRow.appendChild(th);
  });

  // Linhas de hor√°rios
  for (let r = 2; r < semana.length; r++) {
    const tr = document.createElement('tr');
    const cells = semana[r] || [];
    cells.forEach((c, ci) => {
      const info = classificarHorario(c);
      const td = document.createElement('td');
      td.textContent = info.texto;
      if (info.classe) td.classList.add(info.classe);

      const dt = parseDateSafe(datas[ci]);
      if (dt && dt.getTime() === hoje.getTime()) td.classList.add('today');

      const vac = getVacationForDate(dt);
      if (vac) {
        td.classList.add('vacCell');
        td.textContent = 'F√©rias';
      }

      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}

// EVENTOS E INIT (mant√©m do teu c√≥digo)
document.getElementById('prevWeek').addEventListener('click', () => { if (semanaAtual > 0) mostrarSemana(--semanaAtual); });
document.getElementById('nextWeek').addEventListener('click', () => { if (semanaAtual < semanas.length - 1) mostrarSemana(++semanaAtual); });
document.getElementById('feriasBtn').addEventListener('click', () => document.getElementById('feriasOverlay').classList.add('show'));
document.getElementById('feriasClose').addEventListener('click', () => document.getElementById('feriasOverlay').classList.remove('show'));

(async () => {
  await carregarFeriasCSV();
  updateTopCards();
  await carregarCSV();
  document.getElementById('footerLogo').classList.add('show');
})();
</script>
</body>
</html>
