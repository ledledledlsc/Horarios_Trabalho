<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Hor√°rios de Trabalho</title>
<style>
  /* background mais bonito */
  body { 
    font-family: Arial, sans-serif; 
    background: linear-gradient(135deg, #e9f0ff, #f7f9fc);
    text-align: center; 
    padding: 20px; 
  }

  h1 { color: #007bff; margin-bottom: 10px; }
  #semanaTitulo { font-size: 26px; color: #333; margin-bottom: 15px; }

  .buttons { margin-bottom: 16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
  button { margin: 5px; padding: 10px 15px; font-size: 16px; border-radius: 5px; border: none; background: #007bff; color: white; cursor: pointer; transition: 0.2s; }
  button:hover { background: #0056b3; }

  /* bot√£o f√©rias */
  #feriasBtn { background:#8e44ad; }
  #feriasBtn:hover { background:#6f2f8a; }
  #feriasBadge {
    display:none;
    margin-left:8px;
    background: #ffcc00;
    color: #2c3e50;
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: bold;
    font-size: 12px;
    vertical-align: middle;
  }

  /* aviso acima (aparece s√≥ quando est√°s de f√©rias) */
  #feriasAviso {
    display:none;
    width: 100%;
    max-width: 800px;
    margin: 0 auto 14px;
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
    padding: 10px 12px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
  }

  table { border-collapse: collapse; width: 100%; max-width: 800px; margin: 0 auto 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background: white; }
  th, td { border: 1px solid #ccc; padding: 12px; width: 14.28%; word-wrap: break-word; font-size: 16px; }
  th { background: #e9ecef; }

  .green { background-color: #27ae60; color: white; }
  .red { background-color: #e74c3c; color: white; }
  .gray { background-color: #bdc3c7; color: black; }
  .darkgray { background-color: #2c3e50; color: white; }
  .blue { background-color: #3498db; color: white; }
  .blue-dark { background-color: #1d4e89; color: white; font-weight: bold; }

  .today { border: 4px solid orange; font-weight: bold; text-decoration: underline; box-shadow: 0 0 10px rgba(255,165,0,0.7); }

  /* notas (4¬™ linha) */
  .notesRow td {
    font-size: 14px;
    background: #fff;
    color: #333;
    font-style: italic;
  }
  .noteCell {
    border-top: 2px dashed #bbb;
    background: #fafafa;
  }

  #legenda { display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; gap: 15px; }
  .itemLegenda { display: flex; align-items: center; gap: 5px; font-size: 14px; }
  .colorBox { width: 20px; height: 20px; display: inline-block; border-radius: 3px; }

  /* --------- MODAL (POPUP) F√âRIAS --------- */
  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:9999;
  }
  .modal{
    width: min(520px, 100%);
    background: white;
    border-radius: 14px;
    padding: 16px;
    text-align:left;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  .modal h3{ margin:0 0 10px; font-size: 20px; }
  .modal ul{ margin:0 0 12px; padding-left:18px; line-height:1.5; }
  .modal .note{ font-size: 13px; opacity:0.8; margin-bottom: 12px; }
  .modal .actions{ display:flex; justify-content:flex-end; gap:10px; }
  .btn-close{ background:#2c3e50; }
  .btn-close:hover{ background:#1d2a36; }

  /* ---------- LOGO NO FUNDO (clic√°vel + adaptativa) ---------- */
  .footer-logo {
    margin-top: 26px;
    padding-top: 14px;
    display: flex;
    justify-content: center;
    opacity: 0.35; /* discreto */
  }
  .footer-logo a { display: inline-block; }
  .footer-logo img {
    height: 42px;
    max-width: 180px;
    object-fit: contain;
    transition: opacity 0.2s ease, filter 0.2s ease;
  }
  .footer-logo img:hover { opacity: 0.85; }

  /* üåô Modo escuro: melhora a visibilidade da logo + fundo */
  @media (prefers-color-scheme: dark) {
    body {
      background: linear-gradient(135deg, #121212, #1e1e1e);
      color: #eaeaea;
    }
    #semanaTitulo { color: #eaeaea; }
    table { background: #1f1f1f; }
    th { background: #2a2a2a; color: #ffffff; }
    th, td { border-color: #444; }
    .notesRow td { background: #1f1f1f; color: #eaeaea; }
    .noteCell { background: #222; border-top-color: #555; }

    .footer-logo { opacity: 0.7; }
    .footer-logo img { filter: brightness(1.35) contrast(1.1); }
  }

  @media(max-width: 600px) {
    th, td { font-size: 14px; padding: 8px; }
    #semanaTitulo { font-size: 20px; }
    button { font-size: 14px; padding: 8px 12px; }
  }
</style>
</head>
<body>

<h1>Hor√°rios de Trabalho</h1>

<div id="feriasAviso"></div>

<div id="semanaTitulo"></div>
<div class="buttons">
  <button id="prevWeek">Semana anterior</button>
  <button id="nextWeek">Pr√≥xima semana</button>
  <button id="feriasBtn">üèñÔ∏è F√©rias <span id="feriasBadge">AGORA</span></button>
</div>

<div id="legenda">
  <div class="itemLegenda"><span class="colorBox blue"></span> dia</div>
  <div class="itemLegenda"><span class="colorBox blue-dark"></span> Chambre de commerce</div>
  <div class="itemLegenda"><span class="colorBox green"></span> manh√£</div>
  <div class="itemLegenda"><span class="colorBox red"></span> tarde</div>
  <div class="itemLegenda"><span class="colorBox gray"></span> Escola</div>
  <div class="itemLegenda"><span class="colorBox darkgray"></span> Livre</div>
</div>

<table id="horarios"><tbody></tbody></table>

<!-- POPUP F√âRIAS -->
<div class="modal-overlay" id="feriasOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="feriasTitle">
    <h3 id="feriasTitle">üèñÔ∏è F√©rias</h3>
    <ul id="feriasList"></ul>
    <div class="note">
      Esta lista vem automaticamente da tua aba <strong>‚ÄúF√©rias‚Äù</strong> no Google Sheets.
      <br>Formato recomendado: colunas <strong>start</strong>, <strong>end</strong>, <strong>label</strong> (YYYY-MM-DD).
    </div>
    <div class="actions">
      <button class="btn-close" id="feriasClose">Fechar</button>
    </div>
  </div>
</div>

<!-- LOGO (vai ser escondida automaticamente quando est√°s de f√©rias) -->
<div class="footer-logo" id="footerLogo">
  <a href="https://www.cactus.lu/fr" target="_blank" rel="noopener">
    <img
      src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Cactus_Logo.svg/960px-Cactus_Logo.svg.png"
      alt="Logo Cactus">
  </a>
</div>

<script>
/* ==========================
   LINKS
========================== */
const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Horarios_Trabalho.csv';

// Aba "F√©rias" do teu Google Sheets (gid: 849472980)
const FERIAS_CSV_URL = 'https://raw.githubusercontent.com/ledledledlsc/Horarios_Trabalho/main/Ferias.csv';

/* ==========================
   CONFIG
========================== */
const diasSemana = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
const meses = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

let semanas = [];
let semanaAtual = 0;
let linhasCache = [];

/* ==========================
   HELPERS
========================== */
function normalizeCell(x){
  return (x === null || x === undefined) ? '' : String(x).trim();
}

function classificarHorario(horario){
  horario = normalizeCell(horario).replace(/\s/g,'').replace(/h/gi,'');
  const parts = horario.split('-');
  if(parts.length !== 2) return '';

  let inicio = parseFloat(parts[0].replace(':','.'));
  let fim    = parseFloat(parts[1].replace(':','.'));

  if(inicio === 7 && fim === 17) return 'blue-dark';       // Chambre de commerce
  if(inicio >= 12 && fim <= 21) return 'red';              // tarde (at√© 21 tamb√©m)
  if(inicio >= 5 && fim <= 13) return 'green';             // manh√£
  if(inicio >= 10 && fim <= 17) return 'blue';             // dia

  return '';
}

function toDateOnly(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}
function inRange(today, start, end){
  const t = toDateOnly(today).getTime();
  const s = toDateOnly(start).getTime();
  const e = toDateOnly(end).getTime();
  return t >= s && t <= e;
}

function parseCSVLines(text){
  // CSV simples (funciona bem para Sheets)
  return text.trim().split(/\r?\n/).map(l => l.split(',').map(x => x.replace(/^"|"$/g,'').trim()));
}

/* ==========================
   F√âRIAS (AUTO do Sheets)
========================== */
let FERIAS_RANGES = [];
let ESTA_DE_FERIAS = false; // <- vamos usar para esconder a logo

function parseFeriasCSV(text){
  const lines = parseCSVLines(text);
  if(lines.length <= 1) return [];
  const headers = lines[0].map(h => h.toLowerCase());

  const idxStart = headers.indexOf('start');
  const idxEnd = headers.indexOf('end');
  const idxLabel = headers.indexOf('label');

  if(idxStart < 0 || idxEnd < 0) return [];

  return lines.slice(1).map(row => ({
    start: normalizeCell(row[idxStart]),
    end: normalizeCell(row[idxEnd]),
    label: idxLabel >= 0 ? normalizeCell(row[idxLabel]) : ''
  })).filter(r => r.start && r.end);
}

function fmtFeriasRange(r){
  const s = new Date(r.start);
  const e = new Date(r.end);
  const sTxt = `${String(s.getDate()).padStart(2,'0')}/${meses[s.getMonth()]}/${s.getFullYear()}`;
  const eTxt = `${String(e.getDate()).padStart(2,'0')}/${meses[e.getMonth()]}/${e.getFullYear()}`;
  return `${sTxt} ‚Üí ${eTxt}${r.label ? ' ‚Äî ' + r.label : ''}`;
}

async function carregarFeriasCSV(){
  try{
    const res = await fetch(FERIAS_CSV_URL + '&cache=' + new Date().getTime());
    const text = await res.text();
    FERIAS_RANGES = parseFeriasCSV(text);
  }catch(e){
    console.log('Erro ao carregar f√©rias:', e);
    FERIAS_RANGES = [];
  }
}

function renderFeriasUI(){
  const ul = document.getElementById('feriasList');
  ul.innerHTML = '';

  if(!FERIAS_RANGES.length){
    const li = document.createElement('li');
    li.textContent = 'Sem f√©rias encontradas (confirma se a aba tem colunas start/end em YYYY-MM-DD).';
    ul.appendChild(li);
  } else {
    FERIAS_RANGES.forEach(r=>{
      const li = document.createElement('li');
      li.textContent = fmtFeriasRange(r);
      ul.appendChild(li);
    });
  }

  const hoje = new Date();
  ESTA_DE_FERIAS = FERIAS_RANGES.some(r => inRange(hoje, r.start, r.end));

  const badge = document.getElementById('feriasBadge');
  const aviso = document.getElementById('feriasAviso');

  if(ESTA_DE_FERIAS){
    badge.style.display = 'inline-block';
    const r = FERIAS_RANGES.find(x => inRange(hoje, x.start, x.end));
    aviso.style.display = 'block';
    aviso.textContent = `üèñÔ∏è Est√°s de f√©rias agora: ${fmtFeriasRange(r)}`;
  } else {
    badge.style.display = 'none';
    aviso.style.display = 'none';
    aviso.textContent = '';
  }

  // ‚úÖ esconder / mostrar logo automaticamente
  const footerLogo = document.getElementById('footerLogo');
  if(footerLogo){
    footerLogo.style.display = ESTA_DE_FERIAS ? 'none' : 'flex';
  }
}

/* ==========================
   HOR√ÅRIOS (do GitHub CSV)
========================== */
async function carregarCSV() {
  const res = await fetch(GITHUB_CSV_URL + '?cache=' + new Date().getTime());
  const text = await res.text();
  linhasCache = text.split('\n').map(l => l.split(','));

  // encontrar blocos SEMANA
  semanas = [];
  let i = 0;
  while(i < linhasCache.length) {
    if(linhasCache[i][0] && linhasCache[i][0].toUpperCase().includes('SEMANA')) {
      let start = i;

      // blocos m√≠nimos: titulo (start), datas (start+1), hor√°rios (start+2)
      let end = start + 2;

      // se houver mais linhas antes da pr√≥xima "SEMANA", inclui tamb√©m
      while(end + 1 < linhasCache.length &&
            linhasCache[end + 1][0] &&
            !linhasCache[end + 1][0].toUpperCase().includes('SEMANA')) {
        end++;
      }

      semanas.push({start,end});
      i = end + 1;
    } else i++;
  }

  // escolher semana atual (se a data de hoje estiver nas datas da semana)
  const hoje = new Date();
  hoje.setHours(0,0,0,0);
  for(let s=0;s<semanas.length;s++){
    const semana = semanas[s];
    const linhaDatas = linhasCache[semana.start+1] || [];
    if(linhaDatas.some(celula=>{
      const data = new Date(celula);
      if(isNaN(data)) return false;
      data.setHours(0,0,0,0);
      return data.getTime() === hoje.getTime();
    })){
      semanaAtual = s;
      break;
    }
  }

  mostrarSemana(semanaAtual);
}

function mostrarSemana(index){
  const tbody = document.querySelector('#horarios tbody');
  tbody.innerHTML='';

  const semana = semanas[index];
  if(!semana) return;

  document.getElementById('semanaTitulo').textContent = normalizeCell(linhasCache[semana.start][0]);

  const linhaDatas = (linhasCache[semana.start+1] || []).map(normalizeCell);
  const linhaHorarios = (linhasCache[semana.start+2] || []).map(normalizeCell);

  // (opcional) 4¬™ linha de notas ‚Äî se existir no bloco e tiver conte√∫do
  const linhaNotasRaw = linhasCache[semana.start+3];
  const linhaNotas = linhaNotasRaw ? linhaNotasRaw.map(normalizeCell) : null;
  const temNotas = linhaNotas && linhaNotas.some(c => c && c.length > 0);

  // Cabe√ßalho
  const trHead = document.createElement('tr');
  linhaDatas.forEach(celula=>{
    const th = document.createElement('th');
    const data = new Date(celula);
    if(!isNaN(data)){
      const diaSemana = diasSemana[data.getDay()];
      const diaMes = data.getDate();
      const mes = meses[data.getMonth()];
      th.textContent = `${diaSemana} ${diaMes}/${mes}`;
    } else {
      th.textContent = celula;
    }
    trHead.appendChild(th);
  });
  tbody.appendChild(trHead);

  // Linha de hor√°rios
  const trHorario = document.createElement('tr');
  const hoje = new Date(); hoje.setHours(0,0,0,0);

  linhaHorarios.forEach((celula,j)=>{
    const td = document.createElement('td');
    td.textContent = celula;

    const valor = celula.toLowerCase();
    const cor = classificarHorario(celula);

    if(cor) td.classList.add(cor);
    else if(valor.includes('escola')) td.classList.add('gray');
    else if(valor.includes('feriado')) td.classList.add('red');
    else if(valor.includes('libre') || valor.includes('livre')) td.classList.add('darkgray');
    else if(valor.includes('ferias') || valor.includes('f√©rias')) td.classList.add('blue');

    const dataCelula = new Date(linhaDatas[j]);
    if(!isNaN(dataCelula)){
      dataCelula.setHours(0,0,0,0);
      if(dataCelula.getTime() === hoje.getTime()){
        td.classList.add('today');
      }
    }

    trHorario.appendChild(td);
  });
  tbody.appendChild(trHorario);

  // Linha de notas (4¬™ linha), se existir e tiver algo
  if(temNotas){
    const trNotas = document.createElement('tr');
    trNotas.classList.add('notesRow');
    linhaNotas.forEach((nota)=>{
      const td = document.createElement('td');
      td.classList.add('noteCell');
      td.textContent = nota || '';
      trNotas.appendChild(td);
    });
    tbody.appendChild(trNotas);
  }
}

/* ==========================
   BOT√ïES (semanas)
========================== */
document.getElementById('prevWeek').addEventListener('click',()=>{
  if(semanaAtual>0) semanaAtual--;
  mostrarSemana(semanaAtual);
});
document.getElementById('nextWeek').addEventListener('click',()=>{
  if(semanaAtual<semanas.length-1) semanaAtual++;
  mostrarSemana(semanaAtual);
});

/* ==========================
   BOT√ÉO F√âRIAS (modal)
========================== */
const overlay = document.getElementById('feriasOverlay');
document.getElementById('feriasBtn').addEventListener('click', ()=>{
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
});
document.getElementById('feriasClose').addEventListener('click', ()=>{
  overlay.style.display = 'none';
  overlay.setAttribute('aria-hidden','true');
});
overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
  }
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && overlay.style.display === 'flex'){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
  }
});

/* ==========================
   ARRANQUE
========================== */
(async () => {
  await carregarFeriasCSV();  // f√©rias primeiro
  renderFeriasUI();           // badge "AGORA" + lista + esconder logo se f√©rias
  carregarCSV();              // depois hor√°rios (GitHub)
})();
</script>

</body>
</html>
